<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PSI Pharmacy Inspection - Field Prototype</title>
    <style>
        :root {
            --ms-blue: #0078d4;
            --ms-blue-dark: #106ebe;
            --ms-grey-bg: #f3f2f1;
            --ms-grey-border: #d2d0ce;
            --ms-grey-text: #605e5c;
            --ms-red: #d13438;
            --ms-green: #107c10;
            --ms-orange: #ffaa44;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--ms-grey-bg);
            color: #323130;
            font-size: 14px;
            line-height: 1.5;
        }

        .header {
            background: var(--ms-blue);
            color: white;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 900px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .device-badge {
            font-size: 11px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.3);
        }

        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s;
            width: 0%;
        }

        .section-nav {
            background: white;
            border-bottom: 1px solid var(--ms-grey-border);
            padding: 8px 16px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            position: sticky;
            top: 52px;
            z-index: 99;
        }

        .section-nav-inner {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 6px;
        }

        .nav-btn {
            padding: 8px 12px;
            border: 1px solid var(--ms-grey-border);
            background: white;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s;
            font-family: inherit;
        }

        .nav-btn:hover {
            background: var(--ms-grey-bg);
        }

        .nav-btn.active {
            background: var(--ms-blue);
            color: white;
            border-color: var(--ms-blue);
        }

        .nav-btn.has-fail {
            border-left: 3px solid var(--ms-red);
        }

        .nav-btn.complete {
            border-left: 3px solid var(--ms-green);
        }

        .main-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 100px;
        }

        .section {
            display: none;
            background: white;
            border: 1px solid var(--ms-grey-border);
            border-radius: 3px;
            margin-bottom: 16px;
        }

        .section.active {
            display: block;
        }

        .section-header {
            background: linear-gradient(to bottom, #fafafa, #f3f2f1);
            padding: 14px 16px;
            border-bottom: 1px solid var(--ms-grey-border);
            font-weight: 600;
            font-size: 15px;
        }

        .section-body {
            padding: 16px;
        }

        .question {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #edebe9;
        }

        .question:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .question-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
            line-height: 1.4;
        }

        .question-hint {
            font-size: 12px;
            color: var(--ms-grey-text);
            margin-bottom: 10px;
            font-style: italic;
        }

        .conditional {
            margin-left: 16px;
            padding-left: 16px;
            border-left: 3px solid var(--ms-blue);
            margin-top: 16px;
            display: none;
            animation: slideIn 0.2s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .conditional.visible {
            display: block;
        }

        .conditional.level-2 {
            border-left-color: #a0c4e8;
        }

        .conditional.level-3 {
            border-left-color: #cce0f0;
        }

        .required-action {
            background: #fef6f6;
            border: 1px solid var(--ms-red);
            border-left: 4px solid var(--ms-red);
            border-radius: 3px;
            padding: 12px;
            margin-top: 12px;
            display: none;
            font-size: 13px;
        }

        .required-action.visible {
            display: block;
        }

        .required-action-header {
            font-weight: 600;
            color: var(--ms-red);
            font-size: 11px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .required-action-text {
            color: #444;
            line-height: 1.5;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-group.inline {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 10px;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px 14px;
            border: 1px solid var(--ms-grey-border);
            border-radius: 3px;
            transition: all 0.15s;
            user-select: none;
        }

        .radio-option:hover, .checkbox-option:hover {
            background: var(--ms-grey-bg);
        }

        .radio-option.selected {
            border-color: var(--ms-blue);
            background: #f0f6fc;
        }

        .radio-option.selected.pass {
            border-color: var(--ms-green);
            background: #f0fff4;
        }

        .radio-option.selected.fail {
            border-color: var(--ms-red);
            background: #fef6f6;
        }

        .checkbox-option.selected {
            border-color: var(--ms-blue);
            background: #f0f6fc;
        }

        input[type="radio"], input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--ms-blue);
            cursor: pointer;
        }

        input[type="text"], input[type="number"], input[type="date"], input[type="time"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--ms-grey-border);
            border-radius: 3px;
            font-size: 14px;
            font-family: inherit;
        }

        input[type="text"]:focus, input[type="number"]:focus, 
        input[type="date"]:focus, input[type="time"]:focus, textarea:focus {
            outline: none;
            border-color: var(--ms-blue);
            box-shadow: 0 0 0 2px rgba(0,120,212,0.2);
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--ms-grey-border);
            border-radius: 3px;
            font-size: 14px;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
        }

        .repeating-group {
            border: 1px solid var(--ms-grey-border);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .repeating-group-header {
            background: var(--ms-grey-bg);
            padding: 10px 14px;
            font-weight: 600;
            font-size: 12px;
            border-bottom: 1px solid var(--ms-grey-border);
        }

        .repeating-row {
            padding: 14px;
            border-bottom: 1px solid var(--ms-grey-border);
            background: white;
        }

        .repeating-row:last-of-type {
            border-bottom: none;
        }

        .repeating-row-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 10px;
        }

        .repeating-field label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--ms-grey-text);
        }

        .repeating-field input, .repeating-field select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--ms-grey-border);
            border-radius: 3px;
            font-size: 13px;
            font-family: inherit;
        }

        .add-row-btn {
            width: 100%;
            padding: 12px;
            background: var(--ms-grey-bg);
            border: none;
            cursor: pointer;
            font-size: 13px;
            color: var(--ms-blue);
            font-weight: 600;
            font-family: inherit;
        }

        .add-row-btn:hover {
            background: #e8e6e5;
        }

        .remove-row-btn {
            background: none;
            border: 1px solid var(--ms-grey-border);
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: var(--ms-red);
            font-family: inherit;
        }

        .remove-row-btn:hover {
            background: #fef6f6;
            border-color: var(--ms-red);
        }

        .photo-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--ms-grey-border);
        }

        .photo-section-title {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .photo-thumb-container {
            position: relative;
            aspect-ratio: 1;
        }

        .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
            border: 1px solid var(--ms-grey-border);
        }

        .photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: var(--ms-red);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .capture-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: white;
            border: 2px dashed var(--ms-grey-border);
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            color: var(--ms-grey-text);
            font-family: inherit;
        }

        .capture-btn:hover {
            border-color: var(--ms-blue);
            color: var(--ms-blue);
            background: #f8fbfe;
        }

        .signature-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--ms-grey-border);
        }

        .signature-section-title {
            font-weight: 600;
            margin-bottom: 12px;
        }

        .signature-pad-container {
            border: 2px solid red;
            border-radius: 3px;
            overflow: hidden;
            background: #f0f0f0;
            min-height: 150px;
        }

        .signature-pad {
            width: 100%;
            height: 150px;
            display: block;
            touch-action: none;
            cursor: crosshair;
            background: white;
        }

        .signature-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .sig-btn {
            padding: 8px 16px;
            border: 1px solid var(--ms-grey-border);
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
        }

        .sig-btn:hover {
            background: var(--ms-grey-bg);
        }

        .sig-btn.primary {
            background: var(--ms-blue);
            color: white;
            border-color: var(--ms-blue);
        }

        .footer-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--ms-grey-border);
            padding: 12px 16px;
            z-index: 100;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        .footer-inner {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
        }

        .footer-left {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 3px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--ms-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--ms-blue-dark);
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--ms-grey-border);
            color: #323130;
        }

        .btn-secondary:hover {
            background: var(--ms-grey-bg);
        }

        .btn-success {
            background: var(--ms-green);
            color: white;
        }

        .btn-success:hover {
            background: #0b5a0b;
        }

        .analytics-badge {
            font-size: 10px;
            color: var(--ms-grey-text);
            background: var(--ms-grey-bg);
            padding: 4px 8px;
            border-radius: 10px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 16px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 4px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--ms-grey-border);
            font-weight: 600;
            font-size: 16px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--ms-grey-border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .photo-prompt {
            text-align: center;
            padding: 20px;
        }

        .photo-prompt p {
            margin-bottom: 16px;
            color: var(--ms-grey-text);
        }

        .photo-prompt-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section-summary {
            background: var(--ms-grey-bg);
            padding: 12px;
            border-radius: 3px;
            margin-top: 20px;
            font-size: 13px;
        }

        .section-summary-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .summary-pass { color: var(--ms-green); }
        .summary-fail { color: var(--ms-red); }

        @media (max-width: 600px) {
            .radio-group.inline {
                flex-direction: column;
            }
            .repeating-row-fields {
                grid-template-columns: 1fr;
            }
            .footer-inner {
                flex-direction: column;
            }
            .footer-left {
                width: 100%;
            }
            .btn {
                flex: 1;
                text-align: center;
            }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div style="background:#ff6b00;color:white;text-align:center;padding:8px;font-weight:bold;font-size:12px;letter-spacing:1px;">
        ‚ö†Ô∏è FIELD TRIAL - EVALUATION ONLY ‚ö†Ô∏è
    </div>
    <header class="header">
        <div class="header-content">
            <h1>PSI Pharmacy Inspection</h1>
            <div style="display:flex;gap:8px;align-items:center;">
                <button onclick="newInspection()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:6px 12px;border-radius:3px;font-size:12px;cursor:pointer;">New</button>
                <span class="device-badge" id="deviceBadge">Detecting...</span>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </header>

    <nav class="section-nav">
        <div class="section-nav-inner" id="sectionNav"></div>
    </nav>

    <main class="main-content" id="mainContent"></main>

    <footer class="footer-actions">
        <div class="footer-inner">
            <div class="footer-left">
                <button class="btn btn-secondary" onclick="prevSection()">‚Üê Previous</button>
                <button class="btn btn-secondary" onclick="nextSection()">Next ‚Üí</button>
            </div>
            <span class="analytics-badge" id="analyticsBadge">0:00</span>
            <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
            <button class="btn btn-success" onclick="exportData()">Export Data</button>
        </div>
    </footer>

    <div class="modal-overlay" id="photoModal">
        <div class="modal">
            <div class="modal-header">Add Photo Evidence?</div>
            <div class="modal-body">
                <div class="photo-prompt">
                    <p>Would you like to capture photo evidence for this item?</p>
                    <div class="photo-prompt-btns">
                        <button class="btn btn-primary" onclick="acceptPhotoPrompt()">üì∑ Add Photo</button>
                        <button class="btn btn-secondary" onclick="skipPhotoPrompt()">Skip</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">Export Complete</div>
            <div class="modal-body">
                <p>Your inspection data is being downloaded as separate files:</p>
                <ul>
                    <li><strong>inspection_[timestamp].json</strong> - Full structured data</li>
                    <li><strong>inspection_[timestamp].csv</strong> - Flattened summary</li>
                    <li><strong>Photos &amp; signatures</strong> - Downloaded individually</li>
                </ul>
                <p style="font-size:12px; color:var(--ms-grey-text); margin-top:12px;">Note: Your browser may ask permission to download multiple files.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeExportModal()">Done</button>
            </div>
        </div>
    </div>

    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">


    <script>
    // ============================================
    // QUESTIONNAIRE DATA (from Word documents)
    // ============================================
    const questionnaire = {
        title: "PSI Systems Inspection",
        version: "1.0-prototype",
        sections: [
            {
                id: "intro",
                label: "Field Trial Introduction",
                shortLabel: "Intro",
                questions: [
                    {
                        id: "intro_text",
                        label: "This prototype is being used to evaluate whether iPad-based data capture improves or hinders the inspection process compared to handwritten notes.",
                        type: "info"
                    },
                    {
                        id: "intro_testing",
                        label: "What we're testing: Ease of use in the field, speed compared to paper, and impact on inspection flow.",
                        type: "info"
                    },
                    {
                        id: "intro_not",
                        label: "What this is NOT: A production system, connected to Dynamics, or a replacement for the current process.",
                        type: "info"
                    },
                    {
                        id: "intro_feedback",
                        label: "At the end, you'll be asked a few questions about your experience.",
                        type: "info"
                    }
                ]
            },
            {
                id: "inspection_details",
                label: "Inspection Details",
                shortLabel: "Details",
                questions: [
                    {
                        id: "pharmacy_name",
                        label: "Pharmacy Name",
                        type: "text",
                        required: true
                    },
                    {
                        id: "pharmacy_reg_number",
                        label: "Pharmacy Registration Number",
                        type: "text",
                        required: true
                    },
                    {
                        id: "inspection_date",
                        label: "Date of Inspection",
                        type: "date",
                        required: true
                    },
                    {
                        id: "ao_name",
                        label: "Authorised Officer Name",
                        type: "text",
                        required: true
                    }
                ]
            },
            {
                id: "duty_register",
                label: "Professional Cover & Duty Register",
                shortLabel: "Duty Register",
                questions: [
                    {
                        id: "dr_has_register",
                        label: "The pharmacy has a Duty Register.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        required: true,
                        requiredAction: "Confirm that an ongoing, contemporaneous and retrievable record of professional cover is maintained at the pharmacy premises as required by legislation."
                    },
                    {
                        id: "dr_months_reviewed",
                        label: "How many months of the Duty Register were reviewed by the Authorised Officer?",
                        type: "number",
                        visibleIf: { field: "dr_has_register", value: "Pass" }
                    },
                    {
                        id: "dr_entries_complete",
                        label: "The Duty Register contains all entries for professional cover for the time period reviewed.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_has_register", value: "Pass" },
                        requiredAction: "Provide the following: Name and PSI registration number of the registered pharmacists, or where applicable pharmaceutical assistants, who provided professional cover on the dates listed. Confirmation that an ongoing, contemporaneous record of all pharmacists/pharmaceutical assistants working at the pharmacy will be maintained in the Duty Register."
                    },
                    {
                        id: "dr_missing_entries",
                        label: "Records of professional cover have not been entered for the following dates:",
                        type: "repeater",
                        visibleIf: { field: "dr_entries_complete", value: "Fail" },
                        fields: [
                            { id: "date", label: "Date", type: "date" },
                            { id: "from_time", label: "From (Time)", type: "time" },
                            { id: "to_time", label: "To (Time)", type: "time" },
                            { id: "issue", label: "Issue Noted", type: "select", options: ["No Record Entered", "Name Not Entered", "PSI Registration Number Not Entered"] }
                        ]
                    },
                    {
                        id: "dr_entries_signed",
                        label: "Each Duty Register entry is signed by the Pharmacist / Pharmaceutical Assistant.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_has_register", value: "Pass" },
                        requiredAction: "Confirm that each entry for professional cover is signed by that pharmacist/pharmaceutical assistant."
                    },
                    {
                        id: "dr_contemporaneous",
                        label: "All Duty Register entries are maintained contemporaneously and are not recorded in advance.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_has_register", value: "Pass" },
                        requiredAction: "Confirm that all entries in the Duty Register are being maintained contemporaneously and are not recorded in advance."
                    },
                    {
                        id: "dr_contemporaneous_notes",
                        label: "The following was noted by the Authorised Officer in relation to the Duty Register:",
                        type: "textarea",
                        visibleIf: { field: "dr_contemporaneous", value: "Fail" }
                    },
                    {
                        id: "dr_times_included",
                        label: "All Duty Register entries include the pharmacist's arrival and departure times.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_has_register", value: "Pass" },
                        requiredAction: "Confirm that all entries in the Duty Register include the pharmacist's arrival and departure times."
                    },
                    {
                        id: "dr_missing_times",
                        label: "It was noted that the following entries do not include the pharmacist's arrival and / or departure times:",
                        type: "repeater",
                        visibleIf: { field: "dr_times_included", value: "Fail" },
                        fields: [
                            { id: "date", label: "Date", type: "date" },
                            { id: "issue", label: "Issue Noted", type: "select", options: ["Arrival time not entered", "Departure time not entered"] },
                            { id: "additional_info", label: "Additional Information", type: "text" }
                        ]
                    },
                    {
                        id: "dr_weekly_review",
                        label: "The Duty Register is reviewed and signed weekly by the Supervising Pharmacist.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_has_register", value: "Pass" },
                        requiredAction: "Confirm that the Duty Register is reviewed and signed weekly by the Supervising Pharmacist."
                    },
                    {
                        id: "dr_has_sp",
                        label: "The Pharmacy has a nominated Supervising Pharmacist.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Outline how the requirement for a Supervising Pharmacist with 3 years post registration experience being in whole-time charge of the pharmacy is being met."
                    },
                    {
                        id: "dr_sp_details",
                        label: "Supervising Pharmacist Name, PSI Registration number and start date.",
                        type: "textarea",
                        visibleIf: { field: "dr_has_sp", value: "Pass" }
                    },
                    {
                        id: "dr_sp_matches_register",
                        label: "The details provided in relation to the Supervising Pharmacist match those listed on the PSI register.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_has_sp", value: "Pass" },
                        requiredAction: "Confirm the PSI Registration team has been contacted at info@psi.ie regarding the details of the nominated Supervising Pharmacist."
                    },
                    {
                        id: "dr_sp_extended_leave",
                        label: "In a scenario where the Supervising Pharmacist is on extended leave the Pharmacy outlined how the requirement for a Supervising Pharmacist with 3 years post registration experience being in whole-time charge of the pharmacy is being met.",
                        type: "choice",
                        options: ["Pass", "Fail", "Not Applicable"],
                        visibleIf: { field: "dr_has_sp", value: "Pass" },
                        requiredAction: "Outline how the requirement for a Supervising Pharmacist with 3 years post registration experience being in whole-time charge of the pharmacy is being met."
                    },
                    {
                        id: "dr_sp_last_cover_date",
                        label: "Record the date from the Duty Register when the Supervising Pharmacist last provided cover at the Pharmacy.",
                        type: "date",
                        visibleIf: { field: "dr_sp_extended_leave", value: "Fail" }
                    },
                    {
                        id: "dr_sp_cover_in_period",
                        label: "The Duty Register contains a record of professional cover provided by the Supervising Pharmacist for the time period reviewed.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_sp_extended_leave", value: "Pass" },
                        requiredAction: "Outline how the requirement for a Supervising Pharmacist with 3 years post registration experience being in whole-time charge of the pharmacy is being met."
                    },
                    {
                        id: "dr_sp_cover_in_period_notes",
                        label: "The following was noted by the Authorised Officer in relation to professional cover being provided by the Supervising Pharmacist.",
                        type: "textarea",
                        visibleIf: { field: "dr_sp_cover_in_period", value: "Fail" }
                    },
                    {
                        id: "dr_sp_regular_cover",
                        label: "The Supervising Pharmacist provides professional cover in a regular capacity on a consistent and continuous basis during the pharmacy opening hours.",
                        type: "choice",
                        options: ["Pass", "Fail", "Unable to confirm at time of inspection"],
                        visibleIf: { field: "dr_sp_cover_in_period", value: "Pass" },
                        requiredAction: "Confirm that the Supervising Pharmacist is in 'whole time charge' of the pharmacy and provides professional cover in a regular capacity in the professional services area of the pharmacy on a consistent and continuous basis."
                    },
                    {
                        id: "dr_sp_regular_cover_notes",
                        label: "The following was noted by the Authorised Officer in relation to provision of professional cover in a regular capacity by the Supervising Pharmacist.",
                        type: "textarea",
                        visibleIf: { field: "dr_sp_regular_cover", value: "Fail" }
                    },
                    {
                        id: "dr_sp_cover_table",
                        label: "The following table outlines the professional cover provided by the Supervising Pharmacist as recorded in the Duty Register for the time period reviewed during the inspection:",
                        type: "repeater",
                        visibleIf: { field: "dr_sp_regular_cover", value: "Unable to confirm at time of inspection" },
                        fields: [
                            { id: "date", label: "Date", type: "date" },
                            { id: "time_in", label: "Time in", type: "time" },
                            { id: "time_out", label: "Time out", type: "time" }
                        ]
                    },
                    {
                        id: "dr_sp_regular_cover_confirm",
                        label: "The Supervising Pharmacist provides professional cover in a regular capacity on a consistent and continuous basis during the pharmacy opening hours.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "dr_sp_regular_cover", value: "Unable to confirm at time of inspection" },
                        requiredAction: "Confirm that the Supervising Pharmacist is in 'whole time charge' of the pharmacy and provides professional cover in a regular capacity in the professional services area of the pharmacy on a consistent and continuous basis."
                    },
                    {
                        id: "dr_psi_correspondence",
                        label: "Confirmation is provided that the PSI and the pharmacy are corresponding separately regarding the nomination of a Supervising Pharmacist.",
                        type: "choice",
                        options: ["Yes, confirmed by the superintendent pharmacist", "Yes, confirmed by the pharmacist on duty", "Yes, confirmed by the Authorised Officer", "No"],
                        visibleIf: { field: "dr_has_sp", value: "Fail" }
                    },
                    {
                        id: "dr_psi_correspondence_details",
                        label: "Details of the correspondence regarding nomination of a Supervising Pharmacist.",
                        type: "textarea",
                        visibleIf: { field: "dr_psi_correspondence", valueNot: "No" }
                    },
                    {
                        id: "dr_pharm_assistant",
                        label: "Does a pharmaceutical assistant work at the pharmacy?",
                        type: "choice",
                        options: ["Yes", "No"]
                    },
                    {
                        id: "dr_opening_hours_match",
                        label: "Opening hours recorded in the Duty Register must reflect the hours confirmed on the PSI's Pharmacy Register.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that the pharmacy's opening hours have been updated on the PSI's online registration portal."
                    },
                    {
                        id: "dr_opening_hours_issues",
                        label: "The following opening hours recorded in the Duty Register, were not consistent with the opening hours notified to the PSI, and listed on the PSI's online Pharmacy Register:",
                        type: "repeater",
                        visibleIf: { field: "dr_opening_hours_match", value: "Fail" },
                        fields: [
                            { id: "day", label: "Day", type: "text" },
                            { id: "details", label: "Details", type: "text" }
                        ]
                    }
                ]
            },
            {
                id: "sops_policies",
                label: "Standard Operating Procedures (SOPs) and Policies",
                shortLabel: "SOPs & Policies",
                questions: [
                    {
                        id: "sop_available",
                        label: "A set of SOPs and Policies are available for review.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        required: true,
                        requiredAction: "Confirm that the following SOPs and Policies have been developed and implemented in the pharmacy: Dispensing, FMD Operational Management, Dispensing and Counselling for Sodium Valproate, Dispensing and Counselling for Topiramate, Sourcing of Medicines, Storage of Medicines, Expiry Date Checking, Sale and Supply of Non-prescription Medicinal Products, Sale and Supply of Non-prescription Medicinal Products Containing Codeine, Controlled Drugs Receipt, Controlled Drugs Storage, Controlled Drugs Dispensing, Controlled Drugs Emergency Supply, Controlled Drugs Record Keeping, Controlled Drugs Destruction, Medicinal Products Waste Management, Locum Procedure, Housekeeping and Cleanliness, Use of the Patient Consultation Area, Error and Incident Management, Management of Additional Services, Policy on the Use of CRCs, Keyholding Policy (Premises), Keyholding Policy (CD safe), Open Disclosure Policy."
                    },
                    {
                        id: "sop_format",
                        label: "Select the format the SOPs and Policies are available in.",
                        type: "choice",
                        options: ["Hard Copy", "Electronic"],
                        visibleIf: { field: "sop_available", value: "Pass" }
                    },
                    {
                        id: "sop_format_observations",
                        label: "Additional observations regarding the format of SOPs and Policies available in the pharmacy:",
                        type: "textarea",
                        visibleIf: { field: "sop_available", value: "Pass" }
                    },
                    {
                        id: "sop_electronic_readonly",
                        label: "Electronic SOPs and Policy documents are in a read-only format.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_format", value: "Electronic" },
                        requiredAction: "Confirm that the electronic SOPs and Policies are in read-only format to ensure they can only be edited by authorised personnel."
                    },
                    {
                        id: "sop_list_available",
                        label: "The following SOPs and policies are available for review:",
                        type: "checkbox",
                        visibleIf: { field: "sop_available", value: "Pass" },
                        options: [
                            "Controlled Drugs Destruction",
                            "Controlled Drugs Dispensing",
                            "Controlled Drugs Emergency Supply",
                            "Controlled Drugs Receipt",
                            "Controlled Drugs Record Keeping",
                            "Controlled Drugs Storage",
                            "Dispensing",
                            "Dispensing and Counselling for Sodium Valproate",
                            "Dispensing and Counselling for Topiramate",
                            "Error and Incident Management",
                            "Expiry Date Checking",
                            "FMD Operational Management",
                            "Housekeeping and Cleanliness",
                            "Locum Procedure",
                            "Management of Additional Services",
                            "Medicinal Products Waste Management",
                            "Sale and Supply of Non-prescription Medicinal Products",
                            "Sale and Supply of Non-prescription Medicinal Products Containing Codeine",
                            "Sourcing of Medicines",
                            "Storage of Medicines",
                            "Use of the Patient Consultation Area",
                            "Open Disclosure Policy"
                        ]
                    },
                    {
                        id: "sop_all_required",
                        label: "All required SOPs are available at the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that all required SOPs have been developed and implemented in the pharmacy."
                    },
                    {
                        id: "sop_additional_services",
                        label: "SOPs are available at the pharmacy for the following additional services:",
                        type: "checkbox",
                        visibleIf: { field: "sop_available", value: "Pass" },
                        options: [
                            "Home Delivery Services",
                            "Internet Supply of Non-prescription Medicines",
                            "Methadone Services",
                            "Monitored Dosage Systems",
                            "Point of care testing services",
                            "Residential Home Supply",
                            "Vaccination Services",
                            "Veterinary Services",
                            "Other"
                        ]
                    },
                    {
                        id: "sop_additional_services_complete",
                        label: "All required SOPs relating to the management of any additional services provided are available at the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that all required SOPs relating to the management of any additional services provided by the pharmacy have been developed and implemented in the pharmacy."
                    },
                    {
                        id: "sop_crc_policy",
                        label: "A policy on the use of Child Resistant Closures (CRCs) is available for review.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that a documented policy on the Use of Child Resistant Closures (CRCs) has been developed and implemented in the pharmacy."
                    },
                    {
                        id: "sop_keyholding_premises",
                        label: "A Keyholding Policy for the pharmacy premises is available for review.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that a documented Keyholding Policy has been implemented which states that non pharmacists do not have access to the pharmacy, except in the presence of a pharmacist, in order to comply with Regulation 28(c) of the Pharmacy Act 2007."
                    },
                    {
                        id: "sop_keyholding_premises_content",
                        label: "The Keyholding Policy states that non-pharmacists (including staff) do not have access to the pharmacy, except in the presence of a pharmacist.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_keyholding_premises", value: "Pass" },
                        requiredAction: "Confirm that the Keyholding Policy states that non pharmacists (including members of staff) do not have access to the pharmacy, except in the presence of a pharmacist or pharmaceutical assistant (in order to comply with Regulation 28(c) of the Pharmacy Act 2007)."
                    },
                    {
                        id: "sop_keyholding_cd",
                        label: "A Keyholding Policy for the CD safe is available for review.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that a documented Keyholding Policy for the CD safe has been implemented which ensures that access to the CD safe is controlled by the pharmacist."
                    },
                    {
                        id: "sop_keyholding_cd_content",
                        label: "The Keyholding Policy for the CD safe states that access to the CD safe is controlled by the pharmacist, and only the pharmacist or a person operating under the pharmacist's supervision is permitted to access the safe.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_keyholding_cd", value: "Pass" },
                        requiredAction: "Confirm that the Keyholding Policy for the CD safe has been updated and implemented to ensure that access to the CD safe is controlled by the pharmacist, and only the pharmacist or a person operating under the pharmacist's supervision is permitted to access the safe."
                    },
                    {
                        id: "sop_pharmacist_absence",
                        label: "A Pharmacist Absence Policy is in place.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" }
                    },
                    {
                        id: "sop_pharmacist_absence_content",
                        label: "The Pharmacist Absence Policy states that non pharmacists (including staff) do not have access to the pharmacy, except in the presence of a pharmacist.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_pharmacist_absence", value: "Pass" },
                        requiredAction: "Confirm that the Pharmacist Absence Policy states that non pharmacists (including members of staff) do not have access to the pharmacy, except in the presence of a pharmacist or pharmaceutical assistant (in order to comply with Regulation 28(c) of the Pharmacy Act 2007)."
                    },
                    {
                        id: "sop_specific",
                        label: "The SOPs and Policies are specific to the operation of the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that all SOPs and Policies are specific to the operation of the pharmacy and accurately reflect practice at the pharmacy."
                    },
                    {
                        id: "sop_details_completed",
                        label: "All pharmacy-specific details are completed.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_specific", value: "Fail" }
                    },
                    {
                        id: "sop_specific_notes",
                        label: "Pharmacy specific details have not been completed. The following was noted by the Authorised Officer:",
                        type: "textarea",
                        visibleIf: { field: "sop_details_completed", value: "Fail" }
                    },
                    {
                        id: "sop_reflect_practice",
                        label: "The SOPs and Policies reflect practice at the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_specific", value: "Fail" }
                    },
                    {
                        id: "sop_reflect_practice_notes",
                        label: "The SOPs and Policies do not reflect practice at the pharmacy. The following was noted by the Authorised Officer:",
                        type: "textarea",
                        visibleIf: { field: "sop_reflect_practice", value: "Fail" }
                    },
                    {
                        id: "sop_relevant",
                        label: "The SOPs and Policies included in the SOP set are relevant to the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_specific", value: "Fail" },
                        requiredAction: "Confirm that SOPs and Policies which are not applicable to the pharmacy have either been removed from the SOP set or are clearly identified as not having been implemented in the pharmacy."
                    },
                    {
                        id: "sop_relevant_notes",
                        label: "There are SOPs and Policies in the SOP set that are not relevant to the pharmacy. The following was noted by the Authorised Officer:",
                        type: "textarea",
                        visibleIf: { field: "sop_relevant", value: "Fail" }
                    },
                    {
                        id: "sop_no_duplicates",
                        label: "Duplicate or obsolete SOPs / Policies are not included in the SOP set.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that the SOPs and Policies in place are specific to the operation of the pharmacy, and that all duplicate or obsolete SOPs/Policies have been archived."
                    },
                    {
                        id: "sop_no_duplicates_notes",
                        label: "The following was noted by the Authorised Officer in relation to duplicate and/or obsolete SOPs or policies:",
                        type: "textarea",
                        visibleIf: { field: "sop_no_duplicates", value: "Fail" }
                    },
                    {
                        id: "sop_approved",
                        label: "SOPs and Policies are approved by the Superintendent Pharmacist and/or Supervising Pharmacist.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that all the SOPs and Policies have been approved by the Superintendent Pharmacist and/or Supervising Pharmacist."
                    },
                    {
                        id: "sop_implementation_date",
                        label: "SOPs and Policies include an implementation date.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that the SOPs and Policies have an implementation date."
                    },
                    {
                        id: "sop_version",
                        label: "SOPs and Policies include a version number.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that all SOPs and Policies are version controlled and that old versions of SOPs and Policies have been archived and kept separately from newer versions."
                    },
                    {
                        id: "sop_reviewed",
                        label: "SOPs and Policies have been reviewed and assigned a date for the next review.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that all SOPs and Policies have been reviewed and assigned a date for the next review."
                    },
                    {
                        id: "sop_training",
                        label: "Evidence that staff have been trained on the SOPs and Policies is available.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_available", value: "Pass" },
                        requiredAction: "Confirm that all staff have been trained on the SOPs and Policies that are relevant to their roles and responsibilities, and that signed and dated training records are maintained."
                    },
                    {
                        id: "sop_training_format",
                        label: "Select the format that training records are available in.",
                        type: "choice",
                        options: ["Hard copy", "Electronic"],
                        visibleIf: { field: "sop_training", value: "Pass" }
                    },
                    {
                        id: "sop_training_electronic_readonly",
                        label: "SOPs and Policies in electronic format, are in a read-only format.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_training_format", value: "Electronic" },
                        requiredAction: "Confirm that the electronic training records are in read-only format to ensure they can only be edited by authorised personnel."
                    },
                    {
                        id: "sop_training_accessible",
                        label: "The SOPs and Policies are accessible to all pharmacists and management working in the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_training", value: "Pass" },
                        requiredAction: "Confirm that the electronic training records are accessible to all pharmacists and management working in the pharmacy."
                    },
                    {
                        id: "sop_training_signed",
                        label: "Training records are signed and dated by staff members.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "sop_training", value: "Pass" },
                        requiredAction: "Confirm that signed and dated training records are maintained."
                    }
                ]
            },
            {
                id: "error_management",
                label: "Error Management",
                shortLabel: "Error Mgmt",
                questions: [
                    {
                        id: "em_records_maintained",
                        label: "Records of medication errors are maintained at the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        required: true,
                        requiredAction: "Confirm that a record of all medication errors will be maintained at the pharmacy."
                    },
                    {
                        id: "em_template_available",
                        label: "A template log for recording errors is available for use.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_maintained", value: "Fail" },
                        requiredAction: "Confirm that a template log for recording errors is available for use at the pharmacy."
                    },
                    {
                        id: "em_template_format",
                        label: "The format of the template log for recording errors.",
                        type: "choice",
                        options: ["Hard copy", "Electronic"],
                        visibleIf: { field: "em_template_available", value: "Pass" }
                    },
                    {
                        id: "em_template_accessible",
                        label: "The template logs for recording errors are accessible to all pharmacists working in the pharmacy, and to the Authorised Officer.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_template_available", value: "Pass" },
                        requiredAction: "Confirm that the template log for recording errors is accessible to all pharmacists working in the pharmacy, and to PSI Authorised Officers."
                    },
                    {
                        id: "em_template_details_check",
                        label: "The template log facilitates the recording of error details:",
                        type: "checkbox",
                        visibleIf: { field: "em_template_accessible", value: "Pass" },
                        options: [
                            "Details of the medication error",
                            "When the error occurred",
                            "How it was discovered",
                            "How and why it occurred",
                            "Details of interactions with the patient and other healthcare professionals"
                        ]
                    },
                    {
                        id: "em_template_details_complete",
                        label: "The template log facilitates the recording of all error details.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_template_accessible", value: "Pass" },
                        requiredAction: "Confirm that the template clearly outlines all details of the error that occurred."
                    },
                    {
                        id: "em_template_corrective",
                        label: "The template facilitates the recording of corrective actions.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_template_accessible", value: "Pass" },
                        requiredAction: "Confirm that the template log for recording errors includes a section to record corrective actions in response to errors at the pharmacy."
                    },
                    {
                        id: "em_template_preventative",
                        label: "The template facilitates the recording of preventative actions.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_template_accessible", value: "Pass" },
                        requiredAction: "Confirm that the template log for recording errors and incidents includes a section to record preventative actions in response to errors at the pharmacy."
                    },
                    {
                        id: "em_records_format",
                        label: "Select the format of records of medication errors.",
                        type: "choice",
                        options: ["Hard copy", "Electronic"],
                        visibleIf: { field: "em_records_maintained", value: "Pass" }
                    },
                    {
                        id: "em_records_accessible",
                        label: "The records of medication errors are accessible to all pharmacists working in the pharmacy, and to the Authorised Officer.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_maintained", value: "Pass" },
                        requiredAction: "Confirm that records of medication errors at the pharmacy are accessible to all pharmacists working in the pharmacy, and to PSI Authorised Officers."
                    },
                    {
                        id: "em_error_details",
                        label: "Details of the error reviewed:",
                        type: "repeater",
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        fields: [
                            { id: "date", label: "Date Record was made", type: "date" },
                            { id: "initials", label: "Patient initials", type: "text" }
                        ]
                    },
                    {
                        id: "em_record_details_check",
                        label: "Does the record clearly outline details of the medication error?",
                        type: "checkbox",
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        options: [
                            "Details of the medication error",
                            "When the error occurred",
                            "How it was discovered",
                            "How and why it occurred",
                            "Details of interactions with the patient and other healthcare professionals"
                        ]
                    },
                    {
                        id: "em_record_complete",
                        label: "The record of medication errors clearly outlines all of the details of the error that occurred.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        requiredAction: "Confirm that records clearly outline all of the details of the error that occurred."
                    },
                    {
                        id: "em_corrective_actions",
                        label: "The record of medication errors clearly outlines the corrective actions taken to ensure that the impact to the patient is minimised.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        requiredAction: "Confirm that records of corrective actions implemented in response to errors at the pharmacy will be maintained."
                    },
                    {
                        id: "em_preventative_actions",
                        label: "The record of medication errors clearly outlines the preventative actions identified and implemented to prevent recurrence of errors.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        requiredAction: "Confirm that records of preventative actions implemented in response to errors at the pharmacy will be maintained."
                    },
                    {
                        id: "em_actions_completed",
                        label: "All the actions identified in response to an error have been completed.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        requiredAction: "Confirm that all actions identified in response to an error will be completed."
                    },
                    {
                        id: "em_reported_to_sp",
                        label: "Errors are reported to the Supervising and Superintendent Pharmacist(s).",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        requiredAction: "Confirm that errors are reported to the Supervising and Superintendent Pharmacist(s). Please outline how this is carried out."
                    },
                    {
                        id: "em_reviewed_by_sp",
                        label: "Medication error records are reviewed by the Supervising Pharmacist.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        requiredAction: "Confirm that all errors are reviewed by the Supervising Pharmacist."
                    },
                    {
                        id: "em_lessons_communicated",
                        label: "It is confirmed that lessons learnt, corrective actions and preventative actions from errors are communicated with the whole pharmacy team.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_records_accessible", value: "Pass" },
                        requiredAction: "Confirm that lessons learnt, corrective actions and preventative actions from errors are communicated with the whole pharmacy team. Please outline how this is carried out."
                    },
                    {
                        id: "em_near_misses",
                        label: "Records of 'near misses' (i.e. medication errors which do not reach the patient) are maintained in the pharmacy.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that records of 'near misses' (i.e. medication errors which do not reach the patient) are maintained in the pharmacy."
                    },
                    {
                        id: "em_near_misses_reviewed",
                        label: "Records of 'near misses' are regularly reviewed by the Supervising Pharmacist.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_near_misses", value: "Pass" },
                        requiredAction: "Confirm that records of 'near misses' are regularly reviewed by the Supervising Pharmacist."
                    },
                    {
                        id: "em_near_miss_lessons",
                        label: "It is confirmed lessons learnt, corrective actions and preventative actions from near misses are communicated with the whole pharmacy team.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "em_near_misses", value: "Pass" },
                        requiredAction: "Confirm that lessons learnt, corrective actions and preventative actions from near misses are communicated with the whole pharmacy team."
                    }
                ]
            },
            {
                id: "refrigerator",
                label: "Storage of Medicines - Pharmaceutical Refrigerator",
                shortLabel: "Refrigerator",
                questions: [
                    {
                        id: "fr_location",
                        label: "Where is the pharmaceutical refrigerator located?",
                        type: "textarea",
                        required: true
                    },
                    {
                        id: "fr_serviced",
                        label: "The pharmaceutical refrigerator has been serviced in the last year.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that the pharmaceutical refrigerator has been serviced in the last year. Provide photographic evidence.",
                        promptPhoto: false
                    },
                    {
                        id: "fr_service_date",
                        label: "Date of last service performed on the pharmaceutical refrigerator.",
                        type: "date",
                        visibleIf: { field: "fr_serviced", value: "Pass" }
                    },
                    {
                        id: "fr_service_company",
                        label: "Name of company that performed the last service on the pharmaceutical refrigerator.",
                        type: "text",
                        visibleIf: { field: "fr_serviced", value: "Pass" }
                    },
                    {
                        id: "fr_condition",
                        label: "The pharmaceutical refrigerator is in good condition.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that the pharmaceutical refrigerator is in good condition and the deficiencies noted at the inspection have been addressed. Provide photographic evidence.",
                        promptPhoto: false
                    },
                    {
                        id: "fr_condition_notes",
                        label: "The pharmaceutical refrigerator was not in good condition. The following was noted by the Authorised Officer:",
                        type: "textarea",
                        visibleIf: { field: "fr_condition", value: "Fail" }
                    },
                    {
                        id: "fr_clean",
                        label: "The pharmaceutical refrigerator is clean.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that the pharmaceutical refrigerator has been cleaned so that medicines stored in the pharmaceutical refrigerator are not at risk of cross contamination. Provide photographic evidence.",
                        promptPhoto: false
                    },
                    {
                        id: "fr_clean_notes",
                        label: "The pharmaceutical refrigerator was not clean. The following was noted by the Authorised Officer:",
                        type: "textarea",
                        visibleIf: { field: "fr_clean", value: "Fail" }
                    },
                    {
                        id: "fr_human_only",
                        label: "The pharmaceutical refrigerator is used solely for the storage of human medicines.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that the pharmaceutical refrigerator is used solely for the storage of human medicines. Provide photographic evidence.",
                        promptPhoto: false
                    },
                    {
                        id: "fr_human_only_notes",
                        label: "The pharmaceutical refrigerator was not used solely for the storage of human medicines. The following was noted by the Authorised Officer:",
                        type: "textarea",
                        visibleIf: { field: "fr_human_only", value: "Fail" }
                    },
                    {
                        id: "fr_no_vet_medicines",
                        label: "Veterinary medicines are not stored in the pharmaceutical refrigerator.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "fr_human_only", value: "Fail" }
                    },
                    {
                        id: "fr_medicines_condition",
                        label: "Medicines in the pharmaceutical refrigerator are in good condition.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that all medicines stored in the pharmaceutical refrigerator are in good condition.",
                        promptPhoto: false
                    },
                    {
                        id: "fr_medicines_condition_notes",
                        label: "Certain fridge medicines were in poor condition. The following was noted by the Authorised Officer:",
                        type: "textarea",
                        visibleIf: { field: "fr_medicines_condition", value: "Fail" }
                    },
                    {
                        id: "fr_capacity",
                        label: "The pharmaceutical refrigerator is of adequate capacity to allow for organised, well-spaced storage of all medicinal products on the shelves of the unit.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        requiredAction: "Confirm that the pharmaceutical refrigerator is of sufficient size and sufficient space is maintained between the medicines and the internal surfaces of the pharmaceutical refrigerator in accordance with PSI Guidelines.",
                        promptPhoto: false
                    },
                    {
                        id: "fr_capacity_issues",
                        label: "The pharmaceutical refrigerator is not of adequate capacity to allow for organised, well-spaced storage of all medicinal products on the shelves of the unit. The following was noted:",
                        type: "checkbox",
                        visibleIf: { field: "fr_capacity", value: "Fail" },
                        options: [
                            "The pharmaceutical refrigerator was overcrowded",
                            "Sufficient space is not maintained between the medicines and the internal surfaces",
                            "Medicines are stored on the floor of the pharmaceutical refrigerator",
                            "Other"
                        ]
                    },
                    {
                        id: "fr_capacity_other",
                        label: "Pharmaceutical Refrigerator Capacity Further Detail:",
                        type: "textarea",
                        visibleIf: { field: "fr_capacity", value: "Fail" }
                    }
                ]
            },
            {
                id: "prescription_register",
                label: "Prescription Register",
                shortLabel: "Rx Register",
                questions: [
                    {
                        id: "pr_maintained",
                        label: "The Prescription Register is maintained.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        required: true,
                        requiredAction: "Confirm that procedures have been reviewed to ensure that the Prescription Register (Daily Audit) is printed on the day to which the printout relates or within 24 hours thereafter."
                    },
                    {
                        id: "pr_weeks_reviewed",
                        label: "State the number of weeks of the Prescription Register that has been reviewed.",
                        type: "number",
                        visibleIf: { field: "pr_maintained", value: "Pass" }
                    },
                    {
                        id: "pr_maintained_period",
                        label: "The Prescription Register is maintained for the number of weeks reviewed prior to the inspection.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that procedures have been reviewed to ensure that the Prescription Register (Daily Audit) is printed on the day to which the printout relates or within 24 hours thereafter."
                    },
                    {
                        id: "pr_missing_days",
                        label: "The Prescription Register was not available for the following day(s) the pharmacy was open and operating for the number of weeks reviewed:",
                        type: "repeater",
                        visibleIf: { field: "pr_maintained_period", value: "Fail" },
                        fields: [
                            { id: "date", label: "Date", type: "date" },
                            { id: "details", label: "Details", type: "text" }
                        ]
                    },
                    {
                        id: "pr_legible",
                        label: "The Prescription Register is legible.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the Prescription Register printouts are fully legible."
                    },
                    {
                        id: "pr_certified",
                        label: "Where the Prescription Register is a printout, it is dated and certified by the pharmacist daily in accordance with the regulations.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the Prescription Register (Daily Audit) is being dated and certified by the pharmacist on a daily basis."
                    },
                    {
                        id: "pr_certified_notes",
                        label: "The print-out is not routinely dated and certified by the pharmacist on a daily basis. The following was noted:",
                        type: "textarea",
                        visibleIf: { field: "pr_certified", value: "Fail" }
                    },
                    {
                        id: "pr_24hr",
                        label: "The Prescription Register is printed within 24 hours as required by legislation.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the Prescription Register is printed within 24 hours as required by legislation."
                    },
                    {
                        id: "pr_date_supplied",
                        label: "The date the product is supplied is recorded.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the date the product is supplied is recorded in the Prescription Register."
                    },
                    {
                        id: "pr_product_details",
                        label: "The name, quantity, form and strength of the product is recorded.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the name, quantity, form and strength of the product is recorded in the Prescription Register."
                    },
                    {
                        id: "pr_prescriber",
                        label: "The name of prescriber and address is recorded.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the name of the prescriber and their address (where not known to the pharmacist) is recorded in the Prescription Register."
                    },
                    {
                        id: "pr_patient",
                        label: "The name and address of the patient is recorded.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the name and address of the patient is recorded in the Prescription Register."
                    },
                    {
                        id: "pr_rx_date",
                        label: "The date on the prescription is recorded.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the date on the prescription is recorded in the Prescription Register."
                    },
                    {
                        id: "pr_emergency",
                        label: "The nature of emergency supply is recorded (when at the request of the patient).",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that the nature of emergency supply is recorded (when at the request of the patient) in the Prescription Register."
                    },
                    {
                        id: "pr_emergency_notes",
                        label: "The nature of emergency supply is not recorded (when at the request of the patient). The following was noted:",
                        type: "textarea",
                        visibleIf: { field: "pr_emergency", value: "Fail" }
                    },
                    {
                        id: "pr_schemes",
                        label: "All required schemes are included in the Prescription Register.",
                        type: "choice",
                        options: ["Pass", "Fail"],
                        visibleIf: { field: "pr_maintained", value: "Pass" },
                        requiredAction: "Confirm that all required schemes are included in the Prescription Register."
                    }
                ]
            },
            {
                id: "feedback",
                label: "Inspector Feedback",
                shortLabel: "Feedback",
                questions: [
                    {
                        id: "fb_intro",
                        label: "Please provide feedback on your experience using this digital inspection form.",
                        type: "info"
                    },
                    {
                        id: "fb_ease_of_use",
                        label: "Ease of use (1 = very difficult, 5 = very easy)",
                        type: "choice",
                        options: ["1", "2", "3", "4", "5"],
                        required: true
                    },
                    {
                        id: "fb_speed_vs_paper",
                        label: "Compared to paper, completing this inspection was:",
                        type: "choice",
                        options: ["Faster", "About the same", "Slower"],
                        required: true
                    },
                    {
                        id: "fb_flow_disruption",
                        label: "Did the digital form disrupt your inspection flow?",
                        type: "choice",
                        options: ["Not at all", "A little", "Significantly"],
                        required: true
                    },
                    {
                        id: "fb_prefer_over_paper",
                        label: "Would you prefer this over paper for future inspections?",
                        type: "choice",
                        options: ["Yes", "No", "Unsure"],
                        required: true
                    },
                    {
                        id: "fb_conditional_questions",
                        label: "The conditional questions (showing/hiding based on answers) were:",
                        type: "choice",
                        options: ["Helpful", "Confusing", "Didn't notice"],
                        required: true
                    },
                    {
                        id: "fb_photo_capture",
                        label: "Photo capture was:",
                        type: "choice",
                        options: ["Easy", "Awkward", "Didn't use"],
                        required: true
                    },
                    {
                        id: "fb_slowdown",
                        label: "What slowed you down the most?",
                        type: "textarea"
                    },
                    {
                        id: "fb_worked_well",
                        label: "What worked well?",
                        type: "textarea"
                    }
                ]
            },
            {
                id: "signatures",
                label: "Signatures",
                shortLabel: "Signatures",
                questions: []
            }
        ]
    };

    // ============================================
    // STATE & ANALYTICS
    // ============================================
    let formData = {};
    let photos = {};
    let signatures = {};
    let currentSectionIndex = 0;
    let sessionStart = new Date();
    let sectionAnalytics = {};
    let currentPhotoTarget = null;
    let pendingPhotoPrompt = null;

    const deviceInfo = detectDevice();

    function detectDevice() {
        const ua = navigator.userAgent;
        let deviceType = "Desktop";
        
        if (/iPad/.test(ua)) {
            deviceType = "iPad";
        } else if (/iPhone/.test(ua)) {
            deviceType = "iPhone";
        } else if (/Android/.test(ua)) {
            if (/Mobile/.test(ua)) {
                deviceType = "Android Phone";
            } else {
                deviceType = "Android Tablet";
            }
        } else if (/Macintosh/.test(ua) && navigator.maxTouchPoints > 1) {
            deviceType = "iPad"; // iPad with desktop UA
        }

        return {
            deviceType,
            userAgent: ua,
            screen: {
                width: screen.width,
                height: screen.height,
                dpi: window.devicePixelRatio || 1
            },
            orientation: screen.orientation?.type || (window.innerWidth > window.innerHeight ? "landscape" : "portrait")
        };
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('deviceBadge').textContent = deviceInfo.deviceType;
        
        // Initialize section analytics
        questionnaire.sections.forEach(s => {
            sectionAnalytics[s.id] = {
                enteredAt: null,
                exitedAt: null,
                dwellMs: 0,
                scrollEvents: 0,
                photosPrompted: 0,
                photosAccepted: 0,
                photosSkipped: 0,
                textCharsEntered: 0,
                passCount: 0,
                failCount: 0
            };
        });

        renderNav();
        renderSections();
        showSection(0);
        startTimer();
        
        // Photo input handler
        document.getElementById('photoInput').addEventListener('change', handlePhotoCapture);
        
        // Track scroll events
        document.getElementById('mainContent').addEventListener('scroll', () => {
            const section = questionnaire.sections[currentSectionIndex];
            if (section) {
                sectionAnalytics[section.id].scrollEvents++;
            }
        }, { passive: true });
    });

    function startTimer() {
        setInterval(() => {
            const elapsed = Math.floor((new Date() - sessionStart) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('analyticsBadge').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
        }, 1000);
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderNav() {
        const nav = document.getElementById('sectionNav');
        nav.innerHTML = questionnaire.sections.map((s, i) => 
            `<button class="nav-btn" data-index="${i}" onclick="showSection(${i})">${s.shortLabel}</button>`
        ).join('');
    }

    function renderSections() {
        const main = document.getElementById('mainContent');
        main.innerHTML = questionnaire.sections
            .filter(section => section.id !== 'signatures')
            .map((section, si) => `
            <div class="section" id="section-${section.id}" data-section="${section.id}">
                <div class="section-header">${section.label}</div>
                <div class="section-body">
                    ${section.questions.map(q => renderQuestion(q, section.id)).join('')}
                    
                    <div class="photo-section">
                        <div class="photo-section-title">üì∑ Photographs/videos taken by the Authorised Officer on site</div>
                        <div class="photo-grid" id="photos-${section.id}"></div>
                        <button class="capture-btn" onclick="capturePhoto('${section.id}')">
                            üì∑ Capture Photo
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        // Add signature section at the end
        main.innerHTML += `
            <div class="section" id="section-signatures">
                <div class="section-header">Signatures</div>
                <div class="section-body">
                    <div class="signature-section">
                        <div class="signature-section-title">Pharmacist Signature</div>
                        <div class="signature-pad-container">
                            <canvas class="signature-pad" id="sig-pharmacist"></canvas>
                        </div>
                        <div class="signature-actions">
                            <button class="sig-btn" onclick="clearSignature('pharmacist')">Clear</button>
                            <button class="sig-btn primary" onclick="saveSignature('pharmacist')">Save Signature</button>
                        </div>
                    </div>
                    <div class="signature-section">
                        <div class="signature-section-title">Authorised Officer Signature</div>
                        <div class="signature-pad-container">
                            <canvas class="signature-pad" id="sig-ao"></canvas>
                        </div>
                        <div class="signature-actions">
                            <button class="sig-btn" onclick="clearSignature('ao')">Clear</button>
                            <button class="sig-btn primary" onclick="saveSignature('ao')">Save Signature</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        initSignaturePads();
    }

    function renderQuestion(q, sectionId) {
        const qId = `${sectionId}_${q.id}`;
        let visibilityClass = q.visibleIf ? '' : 'visible';
        let conditionalClass = q.visibleIf ? 'conditional' : '';
        
        let html = `<div class="question ${conditionalClass} ${visibilityClass}" id="q-${qId}" data-field="${q.id}">`;
        
        html += `<label class="question-label">${q.label}${q.required ? ' <span style="color:var(--ms-red)">*</span>' : ''}</label>`;
        
        if (q.hint) {
            html += `<div class="question-hint">${q.hint}</div>`;
        }

        switch (q.type) {
            case 'info':
                // Just a label, no input - already rendered above
                break;
            case 'choice':
                html += renderChoiceField(q, qId, sectionId);
                break;
            case 'checkbox':
                html += renderCheckboxField(q, qId, sectionId);
                break;
            case 'text':
                html += `<input type="text" id="${qId}" onchange="updateField('${sectionId}', '${q.id}', this.value)">`;
                break;
            case 'number':
                html += `<input type="number" id="${qId}" onchange="updateField('${sectionId}', '${q.id}', this.value)">`;
                break;
            case 'date':
                html += `<input type="date" id="${qId}" onchange="updateField('${sectionId}', '${q.id}', this.value)">`;
                break;
            case 'time':
                html += `<input type="time" id="${qId}" onchange="updateField('${sectionId}', '${q.id}', this.value)">`;
                break;
            case 'textarea':
                html += `<textarea id="${qId}" onchange="updateField('${sectionId}', '${q.id}', this.value)" oninput="trackTextInput('${sectionId}')"></textarea>`;
                break;
            case 'repeater':
                html += renderRepeater(q, qId, sectionId);
                break;
        }

        if (q.requiredAction) {
            html += `
                <div class="required-action" id="action-${qId}">
                    <div class="required-action-header">Required Action</div>
                    <div class="required-action-text">${q.requiredAction}</div>
                </div>
            `;
        }

        html += '</div>';
        return html;
    }

    function renderChoiceField(q, qId, sectionId) {
        const isPassFail = q.options.includes('Pass') && q.options.includes('Fail');
        return `
            <div class="radio-group ${isPassFail ? 'inline' : ''}">
                ${q.options.map(opt => `
                    <label class="radio-option" id="${qId}_opt_${opt.replace(/\s+/g, '_')}" onclick="selectOption('${sectionId}', '${q.id}', '${opt}', this, ${q.promptPhoto || false})">
                        <input type="radio" name="${qId}" value="${opt}">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        `;
    }

    function renderCheckboxField(q, qId, sectionId) {
        return `
            <div class="checkbox-group">
                ${q.options.map((opt, i) => `
                    <label class="checkbox-option" onclick="toggleCheckbox('${sectionId}', '${q.id}', '${opt}', this)">
                        <input type="checkbox" name="${qId}" value="${opt}">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        `;
    }

    function renderRepeater(q, qId, sectionId) {
        return `
            <div class="repeating-group" id="repeater-${qId}">
                <div class="repeating-group-header">Record entries</div>
                <div class="repeating-rows" id="rows-${qId}">
                    ${renderRepeaterRow(q, qId, sectionId, 0)}
                </div>
                <button class="add-row-btn" onclick="addRepeaterRow('${qId}', '${sectionId}')">+ Add another entry</button>
            </div>
        `;
    }

    function renderRepeaterRow(q, qId, sectionId, rowIndex) {
        return `
            <div class="repeating-row" data-row="${rowIndex}">
                <div class="repeating-row-fields">
                    ${q.fields.map(f => `
                        <div class="repeating-field">
                            <label>${f.label}</label>
                            ${f.type === 'select' 
                                ? `<select onchange="updateRepeaterField('${sectionId}', '${q.id}', ${rowIndex}, '${f.id}', this.value)">
                                    <option value="">Select...</option>
                                    ${f.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                                   </select>`
                                : `<input type="${f.type}" onchange="updateRepeaterField('${sectionId}', '${q.id}', ${rowIndex}, '${f.id}', this.value)">`
                            }
                        </div>
                    `).join('')}
                </div>
                ${rowIndex > 0 ? `<button class="remove-row-btn" onclick="removeRepeaterRow(this)">Remove</button>` : ''}
            </div>
        `;
    }

    // ============================================
    // INTERACTION HANDLERS
    // ============================================
    function showSection(index) {
        // Record exit from current section
        const prevSection = questionnaire.sections[currentSectionIndex];
        if (prevSection && sectionAnalytics[prevSection.id].enteredAt) {
            sectionAnalytics[prevSection.id].exitedAt = new Date();
            sectionAnalytics[prevSection.id].dwellMs += 
                sectionAnalytics[prevSection.id].exitedAt - sectionAnalytics[prevSection.id].enteredAt;
        }

        currentSectionIndex = index;
        
        // Update nav
        document.querySelectorAll('.nav-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i === index);
        });
        
        // Show section
        document.querySelectorAll('.section').forEach((s, i) => {
            s.classList.toggle('active', i === index);
        });

        // Record entry to new section
        const newSection = questionnaire.sections[index];
        if (newSection) {
            sectionAnalytics[newSection.id].enteredAt = new Date();
            
            // Reinitialize signature pads when signatures section is shown
            if (newSection.id === 'signatures') {
                setTimeout(initSignaturePads, 50);
            }
        }

        // Update progress
        updateProgress();
        
        // Scroll to top
        window.scrollTo(0, 0);
    }

    function prevSection() {
        if (currentSectionIndex > 0) {
            showSection(currentSectionIndex - 1);
        }
    }

    function nextSection() {
        if (currentSectionIndex < questionnaire.sections.length - 1) {
            showSection(currentSectionIndex + 1);
        }
    }

    function selectOption(sectionId, fieldId, value, element, promptPhoto) {
        // Update visual state
        element.parentElement.querySelectorAll('.radio-option').forEach(opt => {
            opt.classList.remove('selected', 'pass', 'fail');
        });
        element.classList.add('selected');
        if (value === 'Pass') element.classList.add('pass');
        if (value === 'Fail') element.classList.add('fail');
        
        // Check the radio
        element.querySelector('input').checked = true;
        
        // Store value
        updateField(sectionId, fieldId, value);
        
        // Show/hide required action
        const actionEl = document.getElementById(`action-${sectionId}_${fieldId}`);
        if (actionEl) {
            actionEl.classList.toggle('visible', value === 'Fail');
        }
        
        // Update analytics
        if (value === 'Pass') {
            sectionAnalytics[sectionId].passCount++;
        } else if (value === 'Fail') {
            sectionAnalytics[sectionId].failCount++;
        }
        
        // Handle conditional visibility
        updateConditionalVisibility(sectionId, fieldId, value);
        
        // Prompt for photo if this is a fail with photo prompt
        if (value === 'Fail' && promptPhoto) {
            sectionAnalytics[sectionId].photosPrompted++;
            pendingPhotoPrompt = { sectionId, fieldId };
            document.getElementById('photoModal').classList.add('visible');
        }

        updateNavStatus();
        updateProgress();
    }

    function toggleCheckbox(sectionId, fieldId, value, element) {
        element.classList.toggle('selected');
        const input = element.querySelector('input');
        input.checked = !input.checked;
        
        // Collect all checked values
        const checkedValues = [];
        element.parentElement.querySelectorAll('input:checked').forEach(inp => {
            checkedValues.push(inp.value);
        });
        
        updateField(sectionId, fieldId, checkedValues);
    }

    function updateField(sectionId, fieldId, value) {
        if (!formData[sectionId]) {
            formData[sectionId] = {};
        }
        formData[sectionId][fieldId] = value;
    }

    function updateRepeaterField(sectionId, fieldId, rowIndex, subFieldId, value) {
        if (!formData[sectionId]) formData[sectionId] = {};
        if (!formData[sectionId][fieldId]) formData[sectionId][fieldId] = [];
        if (!formData[sectionId][fieldId][rowIndex]) formData[sectionId][fieldId][rowIndex] = {};
        
        formData[sectionId][fieldId][rowIndex][subFieldId] = value;
    }

    function addRepeaterRow(qId, sectionId) {
        const rowsContainer = document.getElementById(`rows-${qId}`);
        const rowCount = rowsContainer.querySelectorAll('.repeating-row').length;
        
        // Find the question definition
        const section = questionnaire.sections.find(s => s.id === sectionId);
        const fieldId = qId.replace(`${sectionId}_`, '');
        const question = section.questions.find(q => q.id === fieldId);
        
        const newRowHtml = renderRepeaterRow(question, qId, sectionId, rowCount);
        rowsContainer.insertAdjacentHTML('beforeend', newRowHtml);
    }

    function removeRepeaterRow(btn) {
        btn.closest('.repeating-row').remove();
    }

    function updateConditionalVisibility(sectionId, fieldId, value) {
        const section = questionnaire.sections.find(s => s.id === sectionId);
        if (!section) return;

        section.questions.forEach(q => {
            if (q.visibleIf && q.visibleIf.field === fieldId) {
                const qEl = document.getElementById(`q-${sectionId}_${q.id}`);
                if (qEl) {
                    let shouldShow = false;
                    
                    // Handle different visibility conditions
                    if (q.visibleIf.value !== undefined) {
                        // Single value or array of values
                        if (Array.isArray(q.visibleIf.value)) {
                            shouldShow = q.visibleIf.value.includes(value);
                        } else {
                            shouldShow = q.visibleIf.value === value;
                        }
                    } else if (q.visibleIf.valueNot !== undefined) {
                        // Show if value is NOT the specified value
                        if (Array.isArray(q.visibleIf.valueNot)) {
                            shouldShow = !q.visibleIf.valueNot.includes(value);
                        } else {
                            shouldShow = q.visibleIf.valueNot !== value;
                        }
                        // Also need to check value exists (not empty/undefined)
                        shouldShow = shouldShow && value !== undefined && value !== '';
                    }
                    
                    qEl.classList.toggle('visible', shouldShow);
                    
                    if (!shouldShow) {
                        // Clear the field value when hidden
                        delete formData[sectionId]?.[q.id];
                        
                        // Also recursively hide any children that depend on this field
                        updateConditionalVisibility(sectionId, q.id, undefined);
                    }
                }
            }
        });
    }

    function trackTextInput(sectionId) {
        sectionAnalytics[sectionId].textCharsEntered++;
    }

    function updateNavStatus() {
        questionnaire.sections.forEach((section, i) => {
            const btn = document.querySelector(`.nav-btn[data-index="${i}"]`);
            const data = formData[section.id] || {};
            
            const hasFail = Object.values(data).some(v => v === 'Fail');
            const hasAnswers = Object.keys(data).length > 0;
            
            btn.classList.remove('has-fail', 'complete');
            if (hasFail) {
                btn.classList.add('has-fail');
            } else if (hasAnswers) {
                btn.classList.add('complete');
            }
        });
    }

    function updateProgress() {
        let totalQuestions = 0;
        let answeredQuestions = 0;

        questionnaire.sections.forEach(section => {
            section.questions.forEach(q => {
                if (q.required || (q.type === 'choice' && !q.visibleIf)) {
                    totalQuestions++;
                    if (formData[section.id]?.[q.id]) {
                        answeredQuestions++;
                    }
                }
            });
        });

        const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
        document.getElementById('progressFill').style.width = `${progress}%`;
    }

    // ============================================
    // PHOTO CAPTURE
    // ============================================
    function capturePhoto(sectionId) {
        currentPhotoTarget = sectionId;
        document.getElementById('photoInput').click();
    }

    function acceptPhotoPrompt() {
        document.getElementById('photoModal').classList.remove('visible');
        if (pendingPhotoPrompt) {
            sectionAnalytics[pendingPhotoPrompt.sectionId].photosAccepted++;
            currentPhotoTarget = pendingPhotoPrompt.sectionId;
            document.getElementById('photoInput').click();
        }
        pendingPhotoPrompt = null;
    }

    function skipPhotoPrompt() {
        document.getElementById('photoModal').classList.remove('visible');
        if (pendingPhotoPrompt) {
            sectionAnalytics[pendingPhotoPrompt.sectionId].photosSkipped++;
        }
        pendingPhotoPrompt = null;
    }

    function handlePhotoCapture(e) {
        const file = e.target.files[0];
        if (!file || !currentPhotoTarget) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            if (!photos[currentPhotoTarget]) {
                photos[currentPhotoTarget] = [];
            }
            
            const photoData = {
                id: `photo_${Date.now()}`,
                data: event.target.result,
                capturedAt: new Date().toISOString(),
                fileName: `${currentPhotoTarget}_${photos[currentPhotoTarget].length + 1}.jpg`
            };
            
            photos[currentPhotoTarget].push(photoData);
            renderPhotos(currentPhotoTarget);
        };
        reader.readAsDataURL(file);
        
        e.target.value = '';
    }

    function renderPhotos(sectionId) {
        const container = document.getElementById(`photos-${sectionId}`);
        if (!container || !photos[sectionId]) return;

        container.innerHTML = photos[sectionId].map((p, i) => `
            <div class="photo-thumb-container">
                <img src="${p.data}" class="photo-thumb" alt="Photo ${i + 1}">
                <button class="photo-remove" onclick="removePhoto('${sectionId}', ${i})">√ó</button>
            </div>
        `).join('');
    }

    function removePhoto(sectionId, index) {
        photos[sectionId].splice(index, 1);
        renderPhotos(sectionId);
    }

    // ============================================
    // SIGNATURE PAD
    // ============================================
    let signaturePads = {};

    function initSignaturePads() {
        ['pharmacist', 'ao'].forEach(type => {
            const canvas = document.getElementById(`sig-${type}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            
            signaturePads[type] = {
                canvas,
                ctx,
                isDrawing: false,
                lastX: 0,
                lastY: 0
            };

            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            canvas.addEventListener('pointerdown', (e) => startDraw(e, type));
            canvas.addEventListener('pointermove', (e) => draw(e, type));
            canvas.addEventListener('pointerup', () => stopDraw(type));
            canvas.addEventListener('pointerleave', () => stopDraw(type));
        });
    }

    function startDraw(e, type) {
        const pad = signaturePads[type];
        pad.isDrawing = true;
        const rect = pad.canvas.getBoundingClientRect();
        pad.lastX = e.clientX - rect.left;
        pad.lastY = e.clientY - rect.top;
    }

    function draw(e, type) {
        const pad = signaturePads[type];
        if (!pad.isDrawing) return;
        
        const rect = pad.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        pad.ctx.beginPath();
        pad.ctx.moveTo(pad.lastX, pad.lastY);
        pad.ctx.lineTo(x, y);
        pad.ctx.stroke();
        
        pad.lastX = x;
        pad.lastY = y;
    }

    function stopDraw(type) {
        signaturePads[type].isDrawing = false;
    }

    function clearSignature(type) {
        const pad = signaturePads[type];
        const rect = pad.canvas.getBoundingClientRect();
        pad.ctx.clearRect(0, 0, rect.width, rect.height);
        delete signatures[type];
    }

    function saveSignature(type) {
        const pad = signaturePads[type];
        signatures[type] = {
            data: pad.canvas.toDataURL('image/png'),
            savedAt: new Date().toISOString()
        };
        alert(`${type === 'pharmacist' ? 'Pharmacist' : 'Authorised Officer'} signature saved.`);
    }

    // ============================================
    // EXPORT
    // ============================================
    async function exportData() {
        const sessionEnd = new Date();
        const timestamp = new Date().toISOString().slice(0,19).replace(/[:-]/g, '');
        const filePrefix = `PSI_${timestamp}`;
        
        // Finalize current section analytics
        const currentSection = questionnaire.sections[currentSectionIndex];
        if (currentSection && sectionAnalytics[currentSection.id].enteredAt) {
            sectionAnalytics[currentSection.id].exitedAt = sessionEnd;
            sectionAnalytics[currentSection.id].dwellMs += 
                sessionEnd - sectionAnalytics[currentSection.id].enteredAt;
        }

        // Build export payload
        const exportPayload = {
            inspectionId: `INS-${Date.now()}`,
            filePrefix: filePrefix,
            exportedAt: sessionEnd.toISOString(),
            device: deviceInfo,
            analytics: {
                sessionStart: sessionStart.toISOString(),
                sessionEnd: sessionEnd.toISOString(),
                totalDurationMs: sessionEnd - sessionStart,
                sections: Object.entries(sectionAnalytics).map(([id, data]) => ({
                    id,
                    ...data,
                    enteredAt: data.enteredAt?.toISOString(),
                    exitedAt: data.exitedAt?.toISOString()
                })),
                totals: {
                    photosPrompted: Object.values(sectionAnalytics).reduce((a, b) => a + b.photosPrompted, 0),
                    photosAccepted: Object.values(sectionAnalytics).reduce((a, b) => a + b.photosAccepted, 0),
                    photosSkipped: Object.values(sectionAnalytics).reduce((a, b) => a + b.photosSkipped, 0),
                    totalPasses: Object.values(sectionAnalytics).reduce((a, b) => a + b.passCount, 0),
                    totalFails: Object.values(sectionAnalytics).reduce((a, b) => a + b.failCount, 0)
                }
            },
            sections: buildSectionsWithRequiredActions(),
            photos: Object.fromEntries(
                Object.entries(photos).map(([sectionId, photoList]) => [
                    sectionId, 
                    photoList.map(p => ({ fileName: p.fileName, capturedAt: p.capturedAt }))
                ])
            ),
            signatures: Object.fromEntries(
                Object.entries(signatures).map(([k, v]) => [k, { savedAt: v.savedAt }])
            )
        };
        
        function buildSectionsWithRequiredActions() {
            const result = {};
            Object.entries(formData).forEach(([sectionId, fields]) => {
                const section = questionnaire.sections.find(s => s.id === sectionId);
                result[sectionId] = {};
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const question = section?.questions.find(q => q.id === fieldId);
                    const entry = {
                        value: value,
                        question: question?.label || fieldId
                    };
                    
                    // Add required action if answer is Fail and question has one
                    if (value === 'Fail' && question?.requiredAction) {
                        entry.requiredAction = question.requiredAction;
                    }
                    
                    result[sectionId][fieldId] = entry;
                });
            });
            return result;
        }

        // Download JSON
        downloadFile(
            JSON.stringify(exportPayload, null, 2),
            `${filePrefix}_data.json`,
            'application/json'
        );

        // Download CSV after short delay to avoid browser blocking multiple downloads
        setTimeout(() => {
            const csv = generateCSV(exportPayload);
            downloadFile(csv, `${filePrefix}_data.csv`, 'text/csv');
        }, 500);

        // Download photos individually after delays
        let photoDelay = 1000;
        let photoNum = 1;
        Object.entries(photos).forEach(([sectionId, photoList]) => {
            photoList.forEach((photo) => {
                setTimeout(() => {
                    downloadDataURL(photo.data, `${filePrefix}_photo${photoNum}.jpg`);
                    photoNum++;
                }, photoDelay);
                photoDelay += 400;
            });
        });

        // Download signatures
        Object.entries(signatures).forEach(([type, sig]) => {
            setTimeout(() => {
                downloadDataURL(sig.data, `${filePrefix}_signature_${type}.png`);
            }, photoDelay);
            photoDelay += 400;
        });

        document.getElementById('exportModal').classList.add('visible');
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    function downloadDataURL(dataURL, filename) {
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function generateCSV(payload) {
        const rows = [['Section', 'Section Name', 'Field ID', 'Question', 'Value', 'Required Action', 'Device', 'Timestamp']];
        
        Object.entries(payload.sections).forEach(([sectionId, fields]) => {
            // Find section definition
            const section = questionnaire.sections.find(s => s.id === sectionId);
            const sectionName = section ? section.label : sectionId;
            
            Object.entries(fields).forEach(([fieldId, fieldData]) => {
                // Handle both old format (direct value) and new format (object with value)
                const value = typeof fieldData === 'object' && fieldData.value !== undefined 
                    ? fieldData.value 
                    : fieldData;
                const requiredAction = typeof fieldData === 'object' && fieldData.requiredAction 
                    ? fieldData.requiredAction 
                    : '';
                const questionText = typeof fieldData === 'object' && fieldData.question
                    ? fieldData.question
                    : (section?.questions.find(q => q.id === fieldId)?.label || fieldId);
                
                const displayValue = Array.isArray(value) 
                    ? (typeof value[0] === 'object' ? JSON.stringify(value) : value.join('; '))
                    : String(value);
                    
                rows.push([
                    sectionId,
                    sectionName,
                    fieldId,
                    questionText,
                    displayValue,
                    requiredAction,
                    payload.device.deviceType,
                    payload.exportedAt
                ]);
            });
        });

        return rows.map(row => 
            row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
    }

    function closeExportModal() {
        document.getElementById('exportModal').classList.remove('visible');
    }

    // ============================================
    // AUTOSAVE (IndexedDB)
    // ============================================
    const DB_NAME = 'psi_inspection';
    const DB_VERSION = 1;
    const STORE_NAME = 'inspection_data';
    let db = null;

    async function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            request.onupgradeneeded = (e) => {
                const database = e.target.result;
                if (!database.objectStoreNames.contains(STORE_NAME)) {
                    database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
        });
    }

    async function saveToDB() {
        if (!db) return;
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.put({
            id: 'current',
            formData: formData,
            photos: photos,
            signatures: signatures,
            sectionAnalytics: sectionAnalytics,
            sessionStart: sessionStart.toISOString(),
            currentSectionIndex: currentSectionIndex,
            savedAt: new Date().toISOString()
        });
    }

    async function loadFromDB() {
        if (!db) return null;
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get('current');
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => resolve(null);
        });
    }

    async function clearDB() {
        if (!db) return;
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.delete('current');
            request.onsuccess = () => resolve();
            request.onerror = () => resolve();
        });
    }

    function newInspection() {
        if (confirm('Start a new inspection? This will clear all current data.')) {
            clearDB().then(() => {
                location.reload();
            });
        }
    }

    // Modify init to load saved data
    async function initWithRestore() {
        await initDB();
        const saved = await loadFromDB();
        if (saved && saved.formData && Object.keys(saved.formData).length > 0) {
            if (confirm('Resume previous inspection?')) {
                formData = saved.formData || {};
                photos = saved.photos || {};
                signatures = saved.signatures || {};
                sectionAnalytics = saved.sectionAnalytics || sectionAnalytics;
                sessionStart = new Date(saved.sessionStart);
                currentSectionIndex = saved.currentSectionIndex || 0;
                
                // Re-render and restore UI state
                renderNav();
                renderSections();
                restoreFormState();
                showSection(currentSectionIndex);
            } else {
                await clearDB();
            }
        }
        startTimer();
    }

    function restoreFormState() {
        // Restore form field values and visibility
        Object.entries(formData).forEach(([sectionId, fields]) => {
            Object.entries(fields).forEach(([fieldId, value]) => {
                const qId = `${sectionId}_${fieldId}`;
                
                if (Array.isArray(value) && typeof value[0] !== 'object') {
                    // Checkbox values
                    value.forEach(v => {
                        const el = document.querySelector(`input[name="${qId}"][value="${v}"]`);
                        if (el) {
                            el.checked = true;
                            el.closest('.checkbox-option')?.classList.add('selected');
                        }
                    });
                } else if (typeof value === 'string') {
                    // Radio or text
                    const radio = document.querySelector(`input[name="${qId}"][value="${value}"]`);
                    if (radio) {
                        radio.checked = true;
                        const opt = radio.closest('.radio-option');
                        if (opt) {
                            opt.classList.add('selected');
                            if (value === 'Pass') opt.classList.add('pass');
                            if (value === 'Fail') opt.classList.add('fail');
                        }
                        // Show required action if fail
                        const actionEl = document.getElementById(`action-${qId}`);
                        if (actionEl && value === 'Fail') {
                            actionEl.classList.add('visible');
                        }
                    } else {
                        // Text/date/number input
                        const input = document.getElementById(qId);
                        if (input) input.value = value;
                    }
                } else if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object') {
                    // Repeater data - array of objects
                    const rowsContainer = document.getElementById(`rows-${qId}`);
                    if (rowsContainer) {
                        // Find the question definition for this repeater
                        const section = questionnaire.sections.find(s => s.id === sectionId);
                        const question = section?.questions.find(q => q.id === fieldId);
                        
                        if (question && question.type === 'repeater') {
                            // Add extra rows if needed (first row already exists)
                            for (let i = 1; i < value.length; i++) {
                                addRepeaterRow(qId, sectionId);
                            }
                            
                            // Populate all rows
                            value.forEach((rowData, rowIndex) => {
                                const row = rowsContainer.querySelectorAll('.repeating-row')[rowIndex];
                                if (row && rowData) {
                                    Object.entries(rowData).forEach(([subFieldId, subValue]) => {
                                        const input = row.querySelector(`input, select`);
                                        const inputs = row.querySelectorAll('input, select');
                                        inputs.forEach(inp => {
                                            const label = inp.closest('.repeating-field')?.querySelector('label')?.textContent;
                                            const field = question.fields.find(f => f.label === label);
                                            if (field && field.id === subFieldId) {
                                                inp.value = subValue;
                                            }
                                        });
                                    });
                                }
                            });
                        }
                    }
                }
                
                // Trigger visibility
                updateConditionalVisibility(sectionId, fieldId, value);
            });
        });
        
        // Restore photo thumbnails
        Object.keys(photos).forEach(sectionId => {
            renderPhotos(sectionId);
        });
        
        updateNavStatus();
        updateProgress();
    }

    // Override the original DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('deviceBadge').textContent = deviceInfo.deviceType;
        
        questionnaire.sections.forEach(s => {
            sectionAnalytics[s.id] = {
                enteredAt: null,
                exitedAt: null,
                dwellMs: 0,
                scrollEvents: 0,
                photosPrompted: 0,
                photosAccepted: 0,
                photosSkipped: 0,
                textCharsEntered: 0,
                passCount: 0,
                failCount: 0
            };
        });

        renderNav();
        renderSections();
        showSection(0);
        
        // Init DB and restore
        initWithRestore();
        
        document.getElementById('photoInput').addEventListener('change', handlePhotoCapture);
        
        document.getElementById('mainContent').addEventListener('scroll', () => {
            const section = questionnaire.sections[currentSectionIndex];
            if (section) {
                sectionAnalytics[section.id].scrollEvents++;
            }
        }, { passive: true });
        
        // Autosave on any change
        setInterval(saveToDB, 5000); // Save every 5 seconds
    });

    // Also save on field changes
    const originalUpdateField = updateField;
    updateField = function(sectionId, fieldId, value) {
        originalUpdateField(sectionId, fieldId, value);
        saveToDB();
    };

    // ============================================
    // GENERATE WORD REPORT
    // ============================================
    async function generateReport() {
        // Load docx library dynamically
        if (!window.docx) {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/docx@8.2.2/build/index.umd.js';
            document.head.appendChild(script);
            await new Promise(resolve => script.onload = resolve);
        }

        const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, 
                AlignmentType, WidthType, BorderStyle, HeadingLevel } = window.docx;

        // Get pharmacy details
        const pharmacyName = formData.inspection_details?.pharmacy_name || 'Not specified';
        const pharmacyReg = formData.inspection_details?.pharmacy_reg_number || 'Not specified';
        const inspectionDate = formData.inspection_details?.inspection_date || new Date().toISOString().split('T')[0];
        const aoName = formData.inspection_details?.ao_name || 'Not specified';

        // Collect all fails with required actions
        const fails = [];
        questionnaire.sections.forEach(section => {
            if (section.id === 'inspection_details' || section.id === 'signatures') return;
            
            section.questions.forEach(q => {
                const value = formData[section.id]?.[q.id];
                if (value === 'Fail' && q.requiredAction) {
                    fails.push({
                        section: section.label,
                        question: q.label,
                        requiredAction: q.requiredAction
                    });
                }
            });
        });

        // Build document
        const border = { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" };
        const borders = { top: border, bottom: border, left: border, right: border };

        const children = [
            // Header
            new Paragraph({
                children: [new TextRun({ text: "PSI Pharmacy Inspection Report", bold: true, size: 32 })],
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
            }),
            
            // Pharmacy details
            new Paragraph({
                children: [new TextRun({ text: "Pharmacy Name: ", bold: true }), new TextRun(pharmacyName)],
                spacing: { after: 120 }
            }),
            new Paragraph({
                children: [new TextRun({ text: "Registration Number: ", bold: true }), new TextRun(pharmacyReg)],
                spacing: { after: 120 }
            }),
            new Paragraph({
                children: [new TextRun({ text: "Inspection Date: ", bold: true }), new TextRun(inspectionDate)],
                spacing: { after: 120 }
            }),
            new Paragraph({
                children: [new TextRun({ text: "Authorised Officer: ", bold: true }), new TextRun(aoName)],
                spacing: { after: 400 }
            }),

            // Summary
            new Paragraph({
                children: [new TextRun({ text: "Summary of Findings", bold: true, size: 28 })],
                spacing: { before: 300, after: 200 }
            }),
            new Paragraph({
                children: [new TextRun({ text: `Total items requiring action: ${fails.length}`, size: 24 })],
                spacing: { after: 300 }
            })
        ];

        // Fails table
        if (fails.length > 0) {
            children.push(
                new Paragraph({
                    children: [new TextRun({ text: "Required Actions", bold: true, size: 28 })],
                    spacing: { before: 300, after: 200 }
                })
            );

            // Table header
            const tableRows = [
                new TableRow({
                    children: [
                        new TableCell({
                            borders,
                            width: { size: 2000, type: WidthType.DXA },
                            shading: { fill: "D9E2F3" },
                            children: [new Paragraph({ children: [new TextRun({ text: "Section", bold: true })] })]
                        }),
                        new TableCell({
                            borders,
                            width: { size: 3500, type: WidthType.DXA },
                            shading: { fill: "D9E2F3" },
                            children: [new Paragraph({ children: [new TextRun({ text: "Finding", bold: true })] })]
                        }),
                        new TableCell({
                            borders,
                            width: { size: 4000, type: WidthType.DXA },
                            shading: { fill: "D9E2F3" },
                            children: [new Paragraph({ children: [new TextRun({ text: "Required Action", bold: true })] })]
                        })
                    ]
                })
            ];

            // Data rows
            fails.forEach(fail => {
                tableRows.push(
                    new TableRow({
                        children: [
                            new TableCell({
                                borders,
                                width: { size: 2000, type: WidthType.DXA },
                                children: [new Paragraph({ children: [new TextRun({ text: fail.section, size: 20 })] })]
                            }),
                            new TableCell({
                                borders,
                                width: { size: 3500, type: WidthType.DXA },
                                children: [new Paragraph({ children: [new TextRun({ text: fail.question, size: 20 })] })]
                            }),
                            new TableCell({
                                borders,
                                width: { size: 4000, type: WidthType.DXA },
                                children: [new Paragraph({ children: [new TextRun({ text: fail.requiredAction, size: 20 })] })]
                            })
                        ]
                    })
                );
            });

            children.push(
                new Table({
                    width: { size: 9500, type: WidthType.DXA },
                    rows: tableRows
                })
            );
        } else {
            children.push(
                new Paragraph({
                    children: [new TextRun({ text: "No items requiring action were identified during this inspection.", italics: true })],
                    spacing: { after: 300 }
                })
            );
        }

        // Signature lines
        children.push(
            new Paragraph({
                children: [new TextRun({ text: "Signatures", bold: true, size: 28 })],
                spacing: { before: 600, after: 300 }
            }),
            new Paragraph({
                children: [new TextRun("_______________________________")],
                spacing: { after: 80 }
            }),
            new Paragraph({
                children: [new TextRun("Pharmacist Signature / Date")],
                spacing: { after: 300 }
            }),
            new Paragraph({
                children: [new TextRun("_______________________________")],
                spacing: { after: 80 }
            }),
            new Paragraph({
                children: [new TextRun("Authorised Officer Signature / Date")],
                spacing: { after: 300 }
            })
        );

        const doc = new Document({
            styles: {
                default: {
                    document: {
                        run: { font: "Arial", size: 24 }
                    }
                }
            },
            sections: [{
                properties: {
                    page: {
                        size: { width: 11906, height: 16838 }, // A4
                        margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                    }
                },
                children: children
            }]
        });

        // Generate and download
        const buffer = await Packer.toBlob(doc);
        const url = URL.createObjectURL(buffer);
        const a = document.createElement('a');
        a.href = url;
        const reportPrefix = `PSI_${new Date().toISOString().slice(0,19).replace(/[:-]/g, '')}`;
        a.download = `${reportPrefix}_report.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    </script>
</body>
</html>
